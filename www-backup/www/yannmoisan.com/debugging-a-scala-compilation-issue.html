<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="6C_Yu8j-I-U3pjFBjHojSiqvDPxhKJuYqap_tSXV8M4" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Debugging a Scala Compilation Issue, a journey into Variance and LUB | Yann Moisan</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Debugging a Scala Compilation Issue, a journey into Variance and LUB" />
<meta property="og:locale" content="en" />
<meta name="description" content="Debugging a Scala Compilation Issue, a journey into Variance and LUB" />
<meta property="og:description" content="Debugging a Scala Compilation Issue, a journey into Variance and LUB" />
<link rel="canonical" href="https://www.yannmoisan.com/debugging-a-scala-compilation-issue.html" />
<meta property="og:url" content="https://www.yannmoisan.com/debugging-a-scala-compilation-issue.html" />
<meta property="og:site_name" content="Yann Moisan" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-11-30T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Debugging a Scala Compilation Issue, a journey into Variance and LUB" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-11-30T00:00:00+01:00","datePublished":"2024-11-30T00:00:00+01:00","description":"Debugging a Scala Compilation Issue, a journey into Variance and LUB","headline":"Debugging a Scala Compilation Issue, a journey into Variance and LUB","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.yannmoisan.com/debugging-a-scala-compilation-issue.html"},"url":"https://www.yannmoisan.com/debugging-a-scala-compilation-issue.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" /><link type="application/atom+xml" rel="alternate" href="https://www.yannmoisan.com/feed.xml" title="Yann Moisan" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Yann Moisan</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/">Posts</a><a class="page-link" href="/news-from-last-month.html">News from last month</a><a class="page-link" href="/a-propos.html">About me</a><a class="page-link" href="/bookmarks.html">Bookmarks</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Debugging a Scala Compilation Issue, a journey into Variance and LUB</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-11-30T00:00:00+01:00" itemprop="datePublished">Nov 30, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>At work, I recently encountered a tricky compilation issue. To debug it, 
I extracted the minimal amount of code necessary to reproduce the problem. 
After a lot of experimentation, I sought help from a French Scala community. 
By chance, my colleague Marc came to the rescue. 
Since this issue might affect others, I’m detailing the journey in this post 
to help you understand and resolve similar challenges.</p>

<h2 id="introduction">Introduction</h2>

<p>The issue revolves around the following types:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Payload1</span>
<span class="k">trait</span> <span class="nc">Payload2</span>
<span class="k">trait</span> <span class="nc">Rejection</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">ARejection</span><span class="o">(</span><span class="n">reason</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Rejection</span> <span class="k">with</span> <span class="nc">Payload1</span> <span class="k">with</span> <span class="nc">Payload2</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">BRejection</span><span class="o">(</span><span class="n">reason</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Rejection</span> <span class="k">with</span> <span class="nc">Payload1</span> <span class="k">with</span> <span class="nc">Payload2</span>
</code></pre></div></div>

<p>For better visualization, here’s a class diagram:</p>

<p><img src="assets/mermaid-diagram-2024-11-30-154437.svg" alt="class diagram" /></p>

<h2 id="what-are-we-trying-to-achieve">What Are We Trying to Achieve?</h2>

<p>The objective is to create a reusable <em>error handler</em> that can handle various payload types, such as <code class="language-plaintext highlighter-rouge">Payload1</code> or <code class="language-plaintext highlighter-rouge">Payload2</code>.</p>

<p>In the real use case, the ZIO library is involved. However, since the issue is unrelated to ZIO itself, this simplified version is sufficient.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">ZIO</span><span class="o">[</span><span class="kt">+A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">catchSome</span><span class="o">[</span><span class="kt">A1</span> <span class="k">&gt;:</span> <span class="kt">A</span><span class="o">](</span><span class="n">pf</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">ZIO</span><span class="o">[</span><span class="kt">A1</span><span class="o">]])</span> <span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">A1</span><span class="o">]</span> <span class="k">=</span> <span class="nv">pf</span><span class="o">.</span><span class="py">applyOrElse</span><span class="o">(</span><span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">,</span> <span class="o">(</span><span class="k">_</span> <span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">this</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">handleA</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">ZIO</span><span class="o">[</span><span class="kt">ARejection</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">_:</span> <span class="kt">IllegalArgumentException</span> <span class="o">=&gt;</span> <span class="nc">ZIO</span><span class="o">(</span><span class="nc">ARejection</span><span class="o">(</span><span class="s">"a"</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">new</span> <span class="nc">ZIO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Payload1</span><span class="o">()</span> <span class="o">{}).</span><span class="py">catchSome</span><span class="o">(</span><span class="n">handleA</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="why-does-this-work">Why Does This Work?</h2>

<p>The method <code class="language-plaintext highlighter-rouge">catchSome</code> expects a <code class="language-plaintext highlighter-rouge">PartialFunction[Throwable, ZIO[Payload1]]</code>, but we’re passing a <code class="language-plaintext highlighter-rouge">PartialFunction[Throwable, ZIO[ARejection]]</code>.
To understand why this works, we need to discuss <strong>variance</strong>.</p>

<h2 id="variance">Variance</h2>

<p>This isn’t a variance tutorial, but if you’re unfamiliar, I recommend <a href="https://docs.scala-lang.org/tour/variances.html">Scala’s variance documentation</a>. 
For our purposes, here’s a brief overview:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">f</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">ARejection</span> <span class="k">=</span> <span class="nv">ARejection</span><span class="o">.</span><span class="py">apply</span>
<span class="k">val</span> <span class="nv">g</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Rejection</span> <span class="k">=</span> <span class="n">f</span>
</code></pre></div></div>

<p>This works because:</p>
<ul>
  <li>Functions are <strong>covariant</strong> in their return type (<code class="language-plaintext highlighter-rouge">trait Function1[-T1, +R]</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">ARejection</code> is a subtype of <code class="language-plaintext highlighter-rouge">Rejection</code></li>
</ul>

<p>Thus, <code class="language-plaintext highlighter-rouge">String =&gt; ARejection</code> is a subtype of <code class="language-plaintext highlighter-rouge">String =&gt; Rejection</code></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">h</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">ZIO</span><span class="o">[</span><span class="kt">ARejection</span><span class="o">]</span> <span class="k">=</span> <span class="n">name</span> <span class="k">=&gt;</span> <span class="nc">ZIO</span><span class="o">(</span><span class="nc">ARejection</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
<span class="k">val</span> <span class="nv">i</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">ZIO</span><span class="o">[</span><span class="kt">Rejection</span><span class="o">]</span> <span class="k">=</span> <span class="n">h</span>
</code></pre></div></div>

<p>It <strong>still</strong> works because:</p>
<ul>
  <li>ZIO is covariant on its type</li>
  <li><code class="language-plaintext highlighter-rouge">ARejection</code> is a subtype of <code class="language-plaintext highlighter-rouge">Rejection</code></li>
</ul>

<p>So <code class="language-plaintext highlighter-rouge">ZIO[ARejection]</code> is a subtype of <code class="language-plaintext highlighter-rouge">ZIO[Rejection]</code></p>

<p>And because functions are covariant in their return type, <code class="language-plaintext highlighter-rouge">String =&gt; ZIO[ARejection]</code> is a subtype of <code class="language-plaintext highlighter-rouge">String =&gt; ZIO[Rejection]</code></p>

<p>Here’s a visual representation of the relationships:</p>

<p><img src="assets/mermaid-diagram-2024-11-30-164742.svg" alt="class diagram" /></p>

<h2 id="the-compilation-issue">The compilation issue</h2>

<p>Now, we’d like to manage a second type of exception, triggering a BRejection. Here are two straightforward solutions:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">handleB</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">ZIO</span><span class="o">[</span><span class="kt">BRejection</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">_:</span> <span class="kt">IllegalStateException</span> <span class="o">=&gt;</span> <span class="nc">ZIO</span><span class="o">(</span><span class="nc">BRejection</span><span class="o">(</span><span class="s">"b"</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">new</span> <span class="nc">ZIO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Payload1</span><span class="o">()</span> <span class="o">{}).</span><span class="py">catchSome</span><span class="o">(</span><span class="n">handleA</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">solution1</span> <span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Payload1</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ZIO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Payload1</span><span class="o">()</span> <span class="o">{})</span>
  <span class="o">.</span><span class="py">catchSome</span><span class="o">(</span><span class="nv">handleA</span><span class="o">.</span><span class="py">orElse</span><span class="o">(</span><span class="n">handleB</span><span class="o">))</span>

<span class="k">val</span> <span class="nv">solution2</span> <span class="k">:</span> <span class="kt">ZIO</span><span class="o">[</span><span class="kt">Payload1</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ZIO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Payload1</span><span class="o">()</span> <span class="o">{})</span>
  <span class="o">.</span><span class="py">catchSome</span><span class="o">(</span><span class="n">handleA</span><span class="o">)</span>
  <span class="o">.</span><span class="py">catchSome</span><span class="o">(</span><span class="n">handleB</span><span class="o">)</span>
</code></pre></div></div>

<p>While these work, they aren’t as elegant as they could be. Ideally, we’d like a single, unified handler:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">handle</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">ZIO</span><span class="o">[</span><span class="kt">X</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">_:</span> <span class="kt">IllegalArgumentException</span> <span class="o">=&gt;</span> <span class="nc">ZIO</span><span class="o">(</span><span class="nc">ARejection</span><span class="o">(</span><span class="s">"a"</span><span class="o">))</span>
  <span class="k">case</span> <span class="k">_:</span> <span class="kt">IllegalStateException</span> <span class="o">=&gt;</span> <span class="nc">ZIO</span><span class="o">(</span><span class="nc">BRejection</span><span class="o">(</span><span class="s">"b"</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="what-is-the-expected-type-of-x-">What is the expected type of <code class="language-plaintext highlighter-rouge">X</code> ?</h2>

<p>The Scala compiler computes the <strong>least upper bound (LUB)</strong> of the branch types. 
The LUB is the most specific type that is a supertype of all branches.</p>

<p>For ARejection and BRejection, the LUB is <code class="language-plaintext highlighter-rouge">Rejection with Payload1 with Payload2</code> because they share these traits.</p>

<p>Thus, the inferred type X is <code class="language-plaintext highlighter-rouge">Rejection with Payload1 with Payload2</code>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Scala’s powerful type system can sometimes introduce surprising challenges, even for seemingly simple tasks. 
While it may be tempting to duplicate code instead of generalizing, doing so can lead to missed learning opportunities.</p>

<p>By exploring variance and the mechanics of type inference, we’ve seen how Scala arrives at its conclusions. 
Understanding concepts like LUB and variance not only helps solve problems but also deepens our understanding of Scala itself.</p>

<p>Next time you encounter such an issue, take it as a chance to dive into the type system—you might learn something valuable!</p>

  </div><a class="u-url" href="/debugging-a-scala-compilation-issue.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Yann Moisan</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Yann Moisan</li><li><a class="u-email" href="mailto:yamo93+blog@gmail.com">yamo93+blog@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/YannMoisan"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">YannMoisan</span></a></li><li><a href="https://www.linkedin.com/in/yann-moisan-01771746"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">yann-moisan-01771746</span></a></li><li><a href="https://www.twitter.com/yannmoisan"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">yannmoisan</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Blog de Yann Moisan Scala, Java, Linux</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
